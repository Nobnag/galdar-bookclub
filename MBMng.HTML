<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>galdar_MemberMnagement</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="css/gnb.css" />
    <script src="js/gnb.js"></script>
    <script type="text/javascript" src="js/validation.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/MBMng.css" />
    <style>
    </style>
</head>
<body>
    <div id="wrapper">
        <div class="info_table">
            <h1>
                회원정보
            </h1>
            <table class="table_mamber_info">
                <thead>
                    <tr>
                        <th>회원번호</th>
                        <th>회원이메일</th>
                        <th>비밀번호</th>
                        <th>닉네임</th>
                        <th>연락처</th>
                        <th>가입일</th>
                        <th>유료가입현황</th>
                        <th>관리자권한</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 템플릿넣을자리 -->
                    <!-- 노가 하던 방식 
                        <tbody class="table_mamber_info" style="display:none">
                        <tr>
                            <td>{MemberIdx}</td>
                            <td>{Email}</td>
                            <td>{Pw}</td>
                            <td>{Nickname}</td>
                            <td>{Contact}</td>
                            <td>{JoinDatetime}</td>
                            <td>{PremiumMemberYn}</td>
                            <td>{AdminYn}</td>
                        </tr>
                        </tbody> -->
                </tbody>
            </table>
            <!-- 멘토님이 알려주신방식 템플릿 테크 사용 -->
            <template id="template_member_info_row">
                <tr data-memberidx="{MemberIdx}" id="member_info_tr">
                    <td>{MemberIdx}</td>
                    <td>{Email}</td>
                    <td>{Pw}</td>
                    <td>{Nickname}</td>
                    <td>{Contact}</td>
                    <td>{JoinDatetime}</td>
                    <td>{PremiumMemberYn}</td>
                    <td>{AdminYn}</td>
                </tr>
            </template>
            <!-- 멘토님이 알려주신방식 템플릿 테크 사용 -->
        <div class="btn_container">
            <button  class="btn_member_update">회원정보수정</button>
            <button class="btn_member_delete">회원탈퇴</button>
        </div>        
    </div>

    <div id="rp_wrapper">
        <!-- 템플릿 넣을자리 -->
    </div>
<!-- 넣을 템플릿 -->
    <template id="template_Nickname">
    <h1>{Nickname}</h1>
    <div class="member_use_contents">
        <div class="SRContent">
            <h2>작성한 한줄평</h2>
            <ul class="SR">
            </ul>
        </div>
        <div class="MRContent">
            <h2>작성한 줄글서평</h2>
            <ul class="MR">
            </ul>
        </div>
    </div>
    </template>
<!-- 넣을 템플릿 -->
    <template id="template_SR">
        <li>
            {SRBookTitle}
            <p>{SRContent}</p>
        </li>
    </template>
    <template id="template_MR">
        <li>
            {MRBookTitle}
            <p>{MRContent}</p>
        </li>
    </template>

    <script>
        //맴버 정보를 불러온다.
        $(document).ready(function(){
            $.ajax({
                url: '/api/getmember_info',
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    for(var i = 0; i < result.recordset.length; i ++){
                        var row = result.recordset[i];
                        // var html = $('.table_mamber_info').html()
                        // .replace("{MemberIdx}",row.MemberIdx)
                        var html = $("#template_member_info_row").html()
                        //모든 {MemberIdx}를 바꾼다는 뜻 ie까지 연동
                            .replace(/{MemberIdx}/gi, row.MemberIdx)
                            .replace(/{Email}/gi,row.Email)
                            .replace(/{Pw}/gi,row.Pw)
                            .replace(/{Nickname}/gi,row.Nickname)
                            .replace(/{Contact}/gi,row.Contact)
                            .replace(/{JoinDatetime}/gi,row.JoinDatetime)
                            .replace(/{PremiumMemberYn}/gi,row.PremiumMemberYn)
                            .replace(/{AdminYn}/gi,row.AdminYn);
                        $('.info_table table tbody').append(html);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    alert("error");
                }
            });
        });
        //테이블의 특정 tr을 클릭했을때 특정인원 닉네임,한줄평,서평 불러오기
        // var flag = 0;//플러깅하기위한 값
        $(document).on("click",".table_mamber_info tbody tr",function(){
            var MemberIdx = $(this).data("memberidx");
            //해당 줄의 닉네임을 가저온다
            $.ajax({
                url: '/api/getNickname',
                type: 'get',
                datatype: 'json',
                data : {
                    MemberIdx:MemberIdx
                },
                success: function(result){
                        var nt = result.recordset[0]
                        //작성자의 닉네임을 불러온다
                        var html = $("#template_Nickname").html()
                        .replace("{Nickname}",nt.Nickname)
                        $('#rp_wrapper').html(html);
                        //작성한 한줄평을 불러온다
                        for(var i = 0; i < result.recordsets[1].length; i ++) {
                            var srtp = result.recordsets[1][i];
                            var html = $("#template_SR").html()
                            .replace("{SRBookTitle}",srtp.SRBookTitle)
                            .replace("{SRContent}",srtp.SRContent)
                            $('#rp_wrapper .SRContent .SR').append(html);
                        };
                        //작성한 서평을 불러온다
                        for(var i = 0; i < result.recordsets[2].length; i ++) {
                            var srtp = result.recordsets[2][i];
                            var html = $("#template_MR").html()
                            .replace("{MRBookTitle}",srtp.MRBookTitle)
                            .replace("{MRContent}",srtp.MRContent)
                            $('#rp_wrapper .MRContent .MR').append(html);
                        };  
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    alert("error");
                }
            });
        });
        //해당tr 를 더블클릭해 각컬럼을 인풋박스로 만듬
        $(document).on("dblclick",".table_mamber_info tbody tr",function(){
            //플래깅 한다. 방법1*****
            //선택자를 만들때 사용하는 방법으로 매소드 밖에다가 플러그를 설정.
            //if문 사용해서 인풋박스 반복바꿈현상 멈추기
            var count = $(this).find("td").length
            //테이블 선택자를 사용해 각 로우를 인풋박스로 바꿔준다.
                for(var i = 1; i < count;i ++){
                    if(i == 5){
                    }
                    else{
                    var tt = $(this).find("td:eq("+i+")").text()
                    $(this).find("td:eq("+i+")").replaceWith(
                    '<td><input type="text"></td>'
                    );
                    $(this).find('td:eq('+i+') input').val(tt);
                    }
                };
                return false;
        });

        $(document).on("click",".btn_member_update",function(){
            var count = $('.table_mamber_info tbody tr').length
            for(var i = 0; i < count;i ++){
                var MemberIdx = $('.table_mamber_info tbody tr:eq('+i+') td:eq(0)').text();
                var Email = $('.table_mamber_info tbody tr:eq('+i+') td:eq(1) input').val();
                var Pw = $('.table_mamber_info tbody tr:eq('+i+') td:eq(2) input').val();
                var Nickname = $('.table_mamber_info tbody tr:eq('+i+') td:eq(3) input').val();
                var Contact = $('.table_mamber_info tbody tr:eq('+i+') td:eq(4) input').val();
                var PremiumMemberYn = $('.table_mamber_info tbody tr:eq('+i+') td:eq(6) input').val();
                var AdminYn = $('.table_mamber_info tbody tr:eq('+i+') td:eq(7) input').val();
                if(Email !== "" && Pw !=="" && Nickname !== "" && Contact !== "" && PremiumMemberYn !== ""&& AdminYn !== ""){
                    var data = {
                        MemberIdx:MemberIdx
                        ,Email: Email
                        ,Pw: Pw
                        ,Nickname: Nickname
                        ,Contact: Contact
                        ,PremiumMemberYn:PremiumMemberYn
                        ,AdminYn,AdminYn
                    }
                    $.ajax({
                        url: '/api/MemberUpdate',
                        type: 'post',
                        datatype: 'json',
                        data : data,
                        success: function(result){
                            location.href = "/mbmng"
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            // alert("error");
                        }
                    });
                }
            }
            alert("회원 정보 수정이 완료되었습니다.")
        });
        // ****var flag = 0;***
        // $(".table_mamber_info tbody").on("click", "tr", function(){
            // //플래깅 한다. 방법1*****
            // // 선택자를 만들때 사용하는 방법으로 매소드 밖에다가 플러그를
            // if(flag == 0) {
            //     flag = 1;
            //     console.log(flag)
            //     return false;
            // } else {
            //     flag = 0;
            //     console.log(flag)
            //     return false;
            // }*****
            // //플래깅 한다. 방법2
            // if($(this)[0].className == "on"){
            //     $(this).removeClass("on");
            // }
            // else {
            //     $(this).addClass("on");
            // }
    </script>
</body>
</html>