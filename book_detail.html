<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <title>도서 상세 페이지</title>
    <link rel="stylesheet" type="text/css" href="css/gnb.css" />
    <link rel="stylesheet" href="css/book_detail.css">
    <link rel="stylesheet" type="text/css" href="css/footer.css" />
    <script src="js/gnb.js"></script>
    <script src="js/footer.js"></script>
    <script type="text/javascript" src="js/flaviusmatis-simplePagination.js-da97104/jquery.simplePagination.js"></script>
    <link type="text/css" rel="stylesheet" href="js/flaviusmatis-simplePagination.js-da97104/simplePagination.css"/>
    <style>
        /* (s) pagination 스타일 수정 */
        .light-theme a, .light-theme span {
            float:none;
            display: inline-block;
        }
        .simple-pagination li {
            float: none;
            display: inline-block;
        }
        .simple-pagination ul {
            padding: 20px 0 0 0;
        }
        /* (e) pagination 스타일 수정 */
    </style>

    <script>
        // url 에서 parameter 추출
        var getParam = function(sname) {
            var params = location.search.substr(location.search.indexOf("?") + 1);
            var sval = "";
            params = params.split("&");

            for (var i = 0; i < params.length; i++) {
                temp = params[i].split("=");
                if ([temp[0]] == sname) { sval = temp[1]; }
            }

            return sval;
        }

        // 한줄평 조회 함수 선언
        function getSR(){
            var params = {
                book_idx: getParam('book_idx')
            };
            $.ajax({
                url: '/api/getSR',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    // var data = result.recordset[0];
                    if(result.recordset.length == 0){
                        var html = `<p>아직 작성된 한줄평이 없습니다.<p>`;
                        $('.sr_container ul').html(html);
                    } else {
                        for(var i = 0; i < result.recordset.length; i ++){
                            var row = result.recordset[i];
                        var html = $('#sr_template').html().replace("{content}",'\"\&nbsp\&nbsp\&nbsp'+row.SRContent+'\&nbsp\&nbsp\&nbsp\"').replace("{name}","by  "+row.SRWriter).replace("{sr_idx}",row.SRIdx);
                        $('.sr_box .slider').append(html);
                        $('.sr_box .slider li:first-child').css({"opacity":"1"});
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });
        //  글쓰기 / 수정 버튼
            
        }

        // 줄글 서평 글 조회 함수 선언
        var mrPageNo = 1;
        function getMR(){
            var params = {
                book_idx: getParam('book_idx'),
                page_no: mrPageNo,
                page_size: 5
            };
            
            $.ajax({
                url: '/api/getMR',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    // var data = result.recordset[0];
                    if(result.recordset.length > 0 && $(".pagination_mr").html().trim() == ""){
                         $(".pagination_mr").pagination({
                            items: result.recordset[0].totalCnt,
                            itemsOnPage: params.page_size,
                            cssStyle: 'light-theme',
                            prevText: '<',
                            nextText: '>',
                            onPageClick:function(pageNumber, event){
                                mrPageNo = pageNumber;
                                getMR();
                            }
                        });
                    }

                    if(result.recordset.length == 0){
                        var html = "아직 작성된 게시물이 없습니다.";
                        $('.mr_board table').html(html);
                    } else {
                        var html = "";
                        for(var i = 0; i < result.recordset.length; i ++){
                            var row = result.recordset[i];
                            html += $('#tbody_template').html().replace("{no}",row.MRIdx).replace("{name}",row.MRWriter).replace("{data-attr}",row.MRIdx).replace("{title}",row.MRTitle).replace("{date}",row.MRWriteDatetime);
                        }
                        $('.mr_board table tbody').html(html);
                    }
                    
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });

            
        }

        // 북토크 대화록 조회 함수 선언
        function getBT(){
            var params = {
                book_idx: getParam('book_idx')
            };

            $.ajax({
                url: '/api/getBT'
                ,data: params
                ,type: 'get'
                ,datatype: 'jason'
                ,success: function(result){
                    if(result.recordset.length == 0){
                        var text =`<p>대화록은 오프라인 북토크 진행 이후 업로드됩니다.</p>`;
                        $('.btn_update3').hide();
                        $('.bt_container .bt_desc').html(text)
                    } else {
                        // console.log(result);
                        var row = result.recordset[0].BtRecordContent;
                        var bt_writer = result.recordset[0].BtRecordWriter;
                        /* if(row == ""){
                            $('.btn_update3').hide();
                        } */
                        $('.bt_container .bt_desc').html(row);
                        $('.bt_container .bt_writer').html(bt_writer);
                    }
                }
                ,error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    alert("an error occured");
                }
            });
            
        }
 
        // 댓글 삭제 함수
        function clickReplyX(){
            var loginObj = getLoginObj();
            $('.btn_x').click(function(){
                $(this).parent().css('display','none');
                $(this).parent().next().css('display','block');
                var reply_writer = $(this).parent().parent().prev().prev().find('span').html();
                if(loginObj.Nickname == reply_writer){
                    $(this).parent().next().find('input').val(loginObj.Pw);
                }
            });
        }
        
        // 댓글 삭제 확인 함수
        function doReplyX(){
            $('.btn_delete3').click(function(){
                var reply_idx = $(this).data("attr");
                var reply_writer = $(this).parent().parent().parent().find("span").html();
                var reply_pw = $(this).prev().val().trim();
                var thisRow = $(this).parent().parent().parent("div");
                var thisIpt = $(this).prev();
                
                if(thisIpt.val() == ""){
                    alert("비밀번호를 입력하세요.");
                    return false;
                }

                if(confirm("댓글을 삭제하시겠습니까?") == false){
                    return false;
                }
                var params = {
                    reply_idx: reply_idx
                    ,reply_writer: reply_writer
                    ,reply_pw: reply_pw
                }
                $.ajax({
                    url: '/api/deleteReply'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == 'Success'){
                            alert("삭제되었습니다.");
                            location.reload();
                            // thisRow.remove();
                        }

                        if(result.recordset[0].Result == 'Fail'){
                            alert("올바른 비밀번호가 아닙니다.");
                            thisIpt.val('');
                            return false;
                        }
                    }
                    ,error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                    }
                });
            });
        }
        
        // 댓글 삭제 취소 함수
        function undoReplyX(){
            $('.btn_cancel5').click(function(){
                $(this).prev().prev().val('');
                $(this).parent().css('display','none');
                $(this).parent().prev().css('display','block');
            });
        }

        // 댓글 조회 함수 선언
        var replyPageNo = 1;
        function getReply(){
            var params = {
                book_idx: getParam('book_idx'),
                page_no: replyPageNo,
                page_size: 3
            }

            $.ajax({
                url: '/api/getReply',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    if(result.recordset.length > 0 && $(".pagination_reply").html().trim() == ""){
                        $('.pagination_reply').pagination({
                            items: result.recordset[0].totalCnt,
                            itemsOnPage: params.page_size,
                            cssStyle: 'light-theme',
                            prevText: '<',
                            nextText: '>',
                            onPageClick: function(pageNumber, event){
                                replyPageNo = pageNumber;
                                getReply();
                                clickReplyX();
                                doReplyX();
                                undoReplyX();
                            }
                        });
                    }
                    if(result.recordset.length == 0){
                        var html = `<p>아직 작성된 댓글이 없습니다.</p>`;
                    } else {
                        var html = "";
                        for(var i = 0; i < result.recordset.length; i ++){
                        var row = result.recordset[i];
                        html += $('#reply_template').html().replace("{ReplyWriter}",row.ReplyWriter).replace("{ReplyContent}",row.ReplyContent).replace("{Writedatetime}",row.ReplyWriteDatetime).replace("{data-attr}",row.ReplyIdx);
                        }
                    }
                    $('.reply_list_box').html(html);
                    clickReplyX();
                    doReplyX();
                    undoReplyX();
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });
        }


        // 0. 메인 화면
        $(document).ready(function(){
            var loginObj = getLoginObj();

            if(typeof(loginObj) != "undefined"){
                $('.btn_write').show();
                $('.btn_update').show();
                $('.btn_write2').show();
                // $('.btn_update2').show();
                $('input[name="re_password"]').hide();
                $('input[name="re_name"]').val(loginObj.Nickname);
                $('input[name="re_password"]').val(loginObj.Pw);
                $('.ipt_mr_writer').val(loginObj.Nickname);
                $('.ipt_bt_writer').val(loginObj.Nickname);
            } else {
                $('.btn_write').hide();
                $('.btn_update').hide();
                $('.btn_write2').hide();
                $('.btn_update3').hide();
                $('input[name="re_password"]').show();
                $('input[name="re_name"]').removeAttr("readonly");
                $('input[name="re_password"]').removeAttr("readonly");
            }
            if(typeof(loginObj) != "undefined"){
                if(loginObj.AdminYn == "1"){
                    $('.btn_updateBook').show();
                    $('.btn_write3').show();
                } else {
                    $('.btn_updateBook').hide();
                    $('.btn_write3').hide();
                }
            } else {
                $('.btn_updateBook').hide();
                $('.btn_write3').hide();
            }


        // 0-1. 도서 상세 정보 조회
        // 0-1-1. 변수 저장
            var params = {
                book_idx: getParam('book_idx')
            };
        // 0-1-2. ajax 호출
            $.ajax({
                // url: 'http://localhost:3000/api/getBookDetail',
                url: '/api/getBookDetail',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    if(result.recordset.length == 0){
                        alert("유효한 페이지가 아닙니다.");
                        return false;
                    }

                    var data = result.recordset[0];
                    /* 첫번째 방법 */
                    var html = $(".container_book_contents").html();
                    html = html.replace(/{img}/gi, data.BookImg)
                                .replace(/{idx}/gi,data.BookIdx)
                                .replace(/{category}/gi,"[\&nbsp\&nbsp\&nbsp"+data.BookCategory+"\&nbsp\&nbsp\&nbsp]")
                                .replace(/{title}/gi,data.BookTitle)
                                .replace(/{desc}/gi,"\"\&nbsp\&nbsp\&nbsp"+data.BookDesc+"\&nbsp\&nbsp\&nbsp\"")
                                .replace(/{author}/gi,data.BookAuthor)
                                .replace(/{translator}/gi,data.BookTranslator)
                                .replace(/{publisher}/gi,data.BookPublisher)
                                .replace(/{publishDate}/gi,data.BookPubDate)
                                .replace(/{btDate}/gi,data.BookBtDate);
                    $(".container_book_contents").html(html);
                    if($('.book_translator span').html() == ""){
                        $('.book_translator').hide();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    alert("an error occured");
                }
            });
            
        // 0-2. 한줄평 조회
            getSR();
            
        // 0-3. 줄글 서평 조회
            getMR();
           
        // 0-4. 대화록 조회
            getBT();
            
        // 0-5. 댓글 조회
            getReply();
            
        // 1. 도서 정보 수정 버튼 클릭
            var book_idx = getParam('book_idx')
            $('.btn_update_info').click(function(){
                location.href=('./galdar_reg?book_idx='+book_idx)
            });

        // 2. 한줄평
        // 2-1. 글쓰기 버튼 클릭
            $('.btn_write').click(function(){
        // 2-1-1. 창 전환
                $('.sr_container').css('display','none');
                $('.sr_container2').css('display','block');
            });
        // 2-2. 등록버튼 클릭
            $('.btn_regist').click(function(){
        // 2-2-1. 이전에 작성한 적 있으면 불가입니다.
            // if()
        // 2-2-2. 값 가져오기
                var member_idx = loginObj.MemberIdx;
                var book_idx = $('.book_info ul .book_idx span').html();
                var sr_writer = loginObj.Nickname;
                var sr_content = $('.sr_ipt').val();
        // 2-2-3. 미입력시 안내
                if(sr_content == ""){
                    alert('한줄평을 입력하세요.');
                    return false;
                }
                if(sr_content.length > 25){
                    alert("한줄평은 25자 미만으로 입력해주세요.");
                    $('.sr_ipt').focus();
                    return false;
                }
        // 2-2-4. API 전송
                if(sr_content !== ""){
                    var params = {
                        member_idx: member_idx
                        ,book_idx: book_idx
                        ,sr_writer: sr_writer
                        ,sr_content: sr_content
                    };
                    $.ajax({
                        url: '/api/submitSR'
                        ,data: params
                        ,type: 'post' 
                        ,datatype: 'json'
                        ,success: function(result){
                            if(result.recordset[0].Result == 'Fail'){
                                alert('이미 한줄평을 작성하셨습니다.');
                                $('.sr_ipt').val('');
                                $('.sr_container2').css('display','none');
                                // $('.sr_container3').css('display','none');
                                $('.sr_container').css('display','block');
                                return false;
                            }
                            if(result.recordset.length > 0){
                                $('.slider').append("<li><strong>"+sr_content+"</strong><p><em>"+sr_writer+"</em></p></li>");
                                alert('한줄평이 등록되었습니다.');
                                location.reload();
                            }
                        }
                        ,error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                        }
                    });
                }
            });

        // 2-3. 수정버튼 클릭
            $('.btn_update').click(function(){
                // $('.sr_container').css('display','none');
                // $('.sr_container3').css('display','block');
                /* var sr_content = $('.sr_ipt').val();
                if(sr_content == ""){
                    alert('한줄평을 입력하세요.');
                    return false;
                } */
                /* if(sr_content.length > 25){
                    alert("한줄평은 25자 미만으로 입력해주세요.");
                    $('.sr_ipt').focus();
                    return false;
                } */
                var book_idx = $('.book_info ul .book_idx span').html();
                var sr_writer = loginObj.Nickname;
                // console.log(sr_writer);
                $.ajax({
                    url: '/api/getSRContent'
                    ,data: {
                        book_idx: book_idx
                        ,sr_writer: sr_writer
                    }
                    ,type: 'get'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0] == undefined){
                            alert("작성한 한줄평이 없습니다.");
                            return false;
                        }
                        $('.sr_container').css('display','none');
                        $('.sr_container3').css('display','block');
                        var value = result.recordset[0].SRContent;
                        $('.sr_container3 .sr_ipt2').val(value);
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                    }
                });
                
                // 이전에 작성한 글이 있다면, 
                // if()
                // alert("이미 한줄평을 작성하였습니다.");
            });
        // 2-3-1. 수정 - 등록클릭
            $('.btn_regist4').click(function(){
                var sr_updated = $('.sr_container3 .sr_ipt2').val();
                var sr_writer = loginObj.Nickname;
                if(sr_updated == ""){
                    alert('한줄평을 입력하세요.');
                    return false;
                } 
                if(sr_updated.length > 25){
                    alert("한줄평은 25자 미만으로 입력해주세요.");
                    $('.sr_ipt').focus();
                    return false;
                }
                var params = {
                    // sr_idx: sr_idx
                    sr_updated: sr_updated
                    ,sr_writer: sr_writer
                }
                
                $.ajax({
                    url: '/api/updateSR'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == "Success"){
                            alert("수정이 완료되었습니다.");
                        }
                        location.reload();
                    }
                   ,error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                    }
                });

            });
        
        // 2-3-2. 수정 - 한줄평 삭제 클릭
            $('.btn_delete5').click(function(){
                var sr_content = $('.sr_container3 .sr_ipt2').val();
                var sr_writer = loginObj.Nickname;
                
                var params = {
                    sr_content: sr_content
                    ,sr_writer: sr_writer
                }
                
                $.ajax({
                    url: '/api/deleteSR'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == "Success"){
                            alert('삭제되었습니다.');
                            location.reload();
                        }
                    }
                    ,error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                    }
                });
            });
        // 2-4. 취소버튼 클릭
            $('.btn_cancel').click(function(){
        // 2-4-1. 창 전환
                if(confirm("작성된 글은 보관되지 않습니다. 취소하시겠습니까?")){
                    $('.sr_ipt').val('');
                    $('.sr_container2').css('display','none');
                    $('.sr_container3').css('display','none');
                    $('.sr_container').css('display','block');
                }
                else {
                    return false;
                }
            });


        // 3. 줄글 서평            
        // 3-1. 글쓰기 버튼 클릭
            $('.btn_write2').click(function(){
                /* if(){
                    alert('이미 서평을 작성하셨습니다.');
                } */
        // 3-1-1. 창 전환
                $('.mr_container').css('display','none');
                $('.mr_container2').css('display','block');
            });
        // 3-2. 등록버튼 클릭
            $('.btn_regist2').click(function(){
        // 3-2-1. 이전에 작성한 적 있으면 추가 작성 불가.
            // if()
        // 3-5. 값 가져오기
                var member_idx = loginObj.MemberIdx;
                var book_idx = $('.book_info ul .book_idx span').html();
                var mr_writer = $('.ipt_mr_writer').val();
                var mr_title = $('.ipt_mr_title').val();
                var mr_content = $('.ipt_mr_content').val();
        // 3-2-2. 미입력시 안내
                if(mr_title.length > 20){
                    alert("제목은 20자 미만으로 입력해주세요.");
                    $('.ipt_mr_title').focus();
                    return false;
                }

                if(mr_title == '' || mr_content == ''){
                    alert("제목과 서평을 모두 입력해주세요.")
                    return false;
                } 
        // 3-2-3. API 전송
                if(mr_title !== "" && mr_writer !== "" && mr_content !== ""){
                    var data = {
                        member_idx: member_idx
                        ,book_idx: book_idx
                        ,mr_writer: mr_writer
                        ,mr_title: mr_title
                        ,mr_content: mr_content
                    };
                    $.ajax({
                        url: '/api/submitMR',
                        data: data,
                        type: 'post',
                        datatype: 'json',
                        // async: false,
                        success: function(result){
                            // console.log(result);
                            if(result.recordset[0].Result == 'Fail'){
                                alert('이미 서평을 작성하셨습니다.');
                                return false;
                            }
                            if(result.recordset.length > 0){
                                alert("작성이 완료되었습니다.");
                                location.reload();
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            // alert("an error occured");
                        }
                    });
                }
            });

        // 3-3. 취소버튼 클릭
            $('.btn_cancel2').click(function(){
        // 3-3-1. 창 전환
                if(confirm("작성된 글은 보관되지 않습니다. 취소하시겠습니까?")){
                    location.reload();
                    /* $('.mr_container2 .ipt_mr_title, .ipt_mr_content').val('');
                    $('.mr_container2').css('display','none');
                    $('.mr_container4').hide();
                    $('.mr_container').css('display','block'); */
                }
                else {
                    return false;
                }
            });
                       
        // 3-4. 상세 조회
            $(document).on('click', 'tbody .title_span', function(){
                var value = $(this).data("attr");
                // console.log(mr_idx);
                $('.mr_container').hide();
                $('.mr_container3').show();
                $('.mr_wrapper .mr_board').css('background-color','transparent');
                $('.mr_container3 .detail_mr_idx').html(value);
                var mr_idx = $('.mr_container3 .detail_mr_idx').html()
                
                var params2= {
                    mr_idx: mr_idx
                }
                $.ajax({
                    url: '/api/getMRdetail',
                    data: params2,
                    type: 'get',
                    datatype: 'json',
                    // async: false,
                    success: function(result){
                        // var data = result.recordset[0];
                        // $('.mr_container').css('display','none');
                        // $('.mr_container3').css('display','block');
                        // for(var i = 0; i < result.recordset.length; i ++){
                            var row = result.recordset[0];
                            var html = $('.mr_container3').html().replace("{mr_writer}",row.MRWriter).replace("{mr_title}",row.MRTitle).replace("{mr_content}",row.MRContent).replace("{mr_writeDatetime}",row.MRWriteDatetime);
                            $('.mr_container3').html(html);
                            if(loginObj.Nickname == row.MRWriter){
                                $('.btn_update2').show();
                                $('.btn_delete6').show();
                            }
                        // }
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                        alert("an error occured");
                    } 
                });
            });
        // 3-4-1. 상세 조회 - 목록으로 돌아가기
            $(document).on('click', '.btn_cancel3', function(){
                // $('.mr_container3').css('display','none');
                // $('.mr_container').css('display','block');
                location.reload();
            });

        // 3-4-2. 상세 조회 - 수정 클릭
            $(document).on('click', '.btn_update2', function(){
                var mr_idx = $('.mr_container3 .detail_mr_idx').html();
                var mr_writer = $('.mr_container3 .cn_user').html();
                var mr_title = $('.mr_container3 .cn_ttl').html();
                var mr_content = $('.mr_container3 .cn_ct').html();
                $('.mr_container3').css('display','none');
                $('.mr_container4').css('display','block');
                $('.mr_container4 .detail_mr_idx').html(mr_idx)
                // $('.mr_container4 .ipt_mr_writer').val(mr_writer);
                $('.mr_container4 .ipt_mr_title').val(mr_title);
                $('.mr_container4 .ipt_mr_content').html(mr_content);
                
                $('.btn_update5').click(function(){
                    var mr_idx = $('.mr_container4 .detail_mr_idx').html();
                    var mr_writer = $('.mr_container4 .ipt_mr_writer').val();
                    var mr_title = $('.mr_container4 .ipt_mr_title').val();
                    var mr_content = $('.mr_container4 .ipt_mr_content').val();
                    var params = {
                        mr_idx: mr_idx
                        ,mr_writer: mr_writer
                        ,mr_content: mr_content
                        ,mr_title: mr_title
                    }
                    $.ajax({
                        url: '/api/updateMR'
                        ,data: params
                        ,type: 'post'
                        ,datatype: 'json'
                        ,success: function(result){
                            if(result.recordset[0].Result == 'Success'){
                                alert('수정이 완료되었습니다.');
                                location.reload();
                            }
                        }
                        ,error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                        }
                    });
                })
            });

        // 3-4-3. 상세 조회 - 삭제 클릭 
            $(document).on('click', '.btn_delete6', function(){
                var mr_idx = $('.mr_container3 .detail_mr_idx').html();
                var mr_writer = $('.mr_container3 .cn_user').html();
                var params= {
                    mr_idx: mr_idx
                    ,mr_writer: mr_writer
                }
                $.ajax({
                    url: '/api/deleteMR'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == "Success"){
                            alert("삭제가 완료되었습니다.");
                            location.reload();
                        }
                    }
                    ,error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                    }
                });
            });


        // 4. 북토크 대화록
        // 4-1. 작성하기 클릭
            $('.btn_write3').click(function(){
                $('.bt_container').css('display','none');
                $('.bt_container2').css('display','block');
            });
            
        // 4-2. 등록 버튼 클릭
            $('.btn_regist3').click(function(){
                var book_idx = $('.book_info ul .book_idx span').html();
                var bt_content = $('.ipt_bt_content').val();
                var bt_writer = $('.ipt_bt_writer').val();
                // var bt_title = $('.ipt_bt_title').val();
                
                if(bt_content == ''){
                    alert("내용을 입력해주세요.");
                    return false;
                }
        // 4-2-1. API 전송
                if(bt_writer !== "" && bt_content !== ""){
                    var data = {
                        book_idx: book_idx
                        ,bt_content: bt_content
                        ,bt_writer: bt_writer
                    };
                    $.ajax({
                        url: '/api/submitBT',
                        data: data,
                        type: 'post',
                        datatype: 'json',
                        // async: false,
                        success: function(result){
                            if(result.recordset[0].Result == 'Fail'){
                                alert('이미 서평을 작성하셨습니다.');
                                return false;
                            }
                            alert("작성이 완료되었습니다.");
                            location.href=('/book_detail?book_idx='+book_idx)
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            alert("an error occured");
                        }
                    });
                }
            });
        
        // 4-3. 취소 버튼 클릭
            $('.btn_cancel4').click(function(){
                if(confirm("작성된 글은 보관되지 않습니다. 취소하시겠습니까?")){
                    $('.bt_container2 input, textarea').val('');
                    $('.bt_container2').css('display','none');
                    $('.bt_container').css('display','block');
                }
                else {
                    return false;
                }
            });

        // 4-4. 수정하기 클릭
            $('.btn_update3').click(function(){
                $('.bt_container').css('display','none');
                $('.bt_container3').css('display','block');

                var bt_writer = $('.bt_writer').text();
                var btr_desc = $('.bt_desc').text();
                $('.bt_container3 input').val(bt_writer);
                $('.bt_container3 textarea').val(btr_desc);
            });

        // 4-4-1. 대화록 수정 클릭
            $('.btn_update4').click(function(){
                var bt_org = $('.bt_desc').text();
                var book_idx = $('.book_info ul .book_idx span').html();
                var bt_updated = $('.bt_container3 textarea').val();
                var bt_writer = $('.ipt_bt_writer2').val();
                
                if(bt_org == bt_updated){
                    alert('수정 사항을 입력하세요.');
                    return false;
                } 

                if(bt_updated == ""){
                    alert("내용을 입력하세요");
                    return false;
                }
                
                var params = {
                    book_idx: book_idx
                    ,bt_updated: bt_updated
                    ,bt_writer: bt_writer
                }
                $.ajax({
                    url: '/api/updateBT'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == 'Success'){
                            alert('수정이 완료되었습니다.');
                            location.reload();
                        }

                        if(result.recordset[0].Result == 'Error'){
                            alert('DB에서 오류가 발생하였습니다. 관리자 문의.')
                        }
                    }
                    ,error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                        alert("북토크 대화록 수정 중 오류가 발생했습니다.")
                    }
                });
            })
        // 4-4-2. 대화록 삭제 클릭
            $('.btn_delete4').click(function(){
                var book_idx = $('.book_info ul .book_idx span').html();
                var bt_writer = $('.bt_container3 input').val();

                if(confirm("해당 대화록을 삭제하시겠습니까?") == false){
                    return false;
                }

                var params = {
                    book_idx: book_idx
                    ,bt_writer: bt_writer
                };
                $.ajax({
                    url: '/api/deleteBT'
                    ,data: params
                    ,type: 'post'
                    ,datatype: 'json'
                    ,success: function(result){
                        if(result.recordset[0].Result == 'Success'){
                            alert('대화록이 삭제되었습니다.');
                            $('.bt_container3').css("display","none");
                            $('.bt_container').css("display","block");
                            var text =`<p>대화록은 오프라인 북토크 진행 이후 업로드됩니다.</p>`;
                            $('.bt_container .bt_desc').html(text)
                        }
                    }
                    ,error: function(jqXHR,textStatus,errorThrown){
                        console.log(errorThrown);
                        alert("an error occured");
                    }
                });
            });
        // 4-4-3. 취소 클릭
            $('.btn_cancel6').click(function(){
                var btr_text = $('.bt_desc').text();
                if(confirm("수정사항은 저장되지 않습니다. 수정을 취소하시겠습니까?")){
                    $('.bt_container3 textarea').val(btr_text);
                    $('.bt_container3').css('display','none');
                    $('.bt_container').css('display','block');
                }
            });


        // 5. 댓글 작성
            $('.btn_reg').click(function(){
                /* if(typeof(loginObj) != 'undefined'){
                    var member_idx = loginObj.MemberIdx;
                } else {
                    var member_idx = 0;
                } */
                var book_idx = $('.book_info ul .book_idx span').html();
                var reply_name = $('input[name="re_name"]').val();
                var reply_pw = $('input[name="re_password"]').val();
                var reply_content = $('.ipt_reply_content').val();
                if(reply_content.length > 80){
                    alert("댓글은 80자 미만으로 입력해주세요.");
                    $('.ipt_reply_content').focus();
                    return false;
                }
                if(reply_name == "" || reply_pw == "" || reply_content == ""){
                    alert('이름과 비밀번호, 내용을 모두 입력하세요.');
                    return false;
                }
                
                if(reply_name !== "" && reply_pw !== "" && reply_content !== ""){
                    var params = {
                        // member_idx: member_idx
                        book_idx: book_idx
                        ,reply_name: reply_name
                        ,reply_content: reply_content
                        ,reply_pw: reply_pw
                    };

                    $.ajax({
                        url: '/api/submitReply',
                        data: params,
                        type: 'post',
                        datatype: 'json',
                        // async: false,
                        success: function(result){
                            if(result.recordset[0].Result == 'Success'){
                                alert("작성이 완료되었습니다.");
                                location.reload();
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            // alert("an error occured");
                        }
                    });
                }
            });

            
            



        // 99. 한줄평 슬라이드 구현하기.
        // 99-1. 변수 정의.
            var $slider = $('.slider');
            var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);

            startSlide();
            
            var theInterval;
            
            function startSlide(){
                theInterval = setInterval(NextSlide, 3000);
                // var $firstSlide = $slider.find('li').first().stop(true).animate ({'opacity':1},100);
            };
            
            function stopSlide(){
                clearInterval(theInterval);
            }
            
        // 99-2. '<' 버튼 누를 때 실행할 함수.
            function PrevSlide(){
                // 타이머 초기화
                stopSlide();
                startSlide();

                var $lastSlide = $slider.find('li').last().prependTo($slider);
                var $secondSlide = $slider.find('li').eq(1).stop(true).animate({'opacity':0},100);
                var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);
            }

        // 99-3. '>' 버튼 누를 때 실행할 함수.
            function NextSlide(){
                // 타이머 초기화
                stopSlide();
                startSlide();

                $firstSlide = $slider.find('li').first().appendTo($slider);
                var $lastSlide = $slider.find('li').last().stop(true).animate({'opacity':0},100);
                var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);
            }
            
        // 99-4. '<' 버튼 누를 때.
            $('.btn_left').on('click',function(){
                PrevSlide();
            });

        // 99-5. '>' 버튼 누를 때.
            $('.btn_right').on('click',function(){
                NextSlide();
            });

        // 99-6. hover시 동작
            $('.slider').hover(function(){
                stopSlide();
            }, function(){
                startSlide();
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- 도서 정보 -->
        <div class="wrapper info_wrapper">
            <h4>도서 정보</h4>
            <div class="container_book_contents">
                <div class="book_img">
                    <img src="/uploads/{img}">
                </div>
                <div class="book_info_wrapper">
                    <div class="book_info">
                        <ul>
                        <li class="book_category">{category}</li>
                        <h2 class="book_title">{title}</h2>
                        <li class="book_desc"><em>{desc}</em></li>
                        <li class="book_idx">
                            <p>도서번호</p>
                            <span>{idx}</span>
                        </li>
                        <li class="book_author">
                            <p>저자</p>
                            <span>{author}</span>
                        </li>
                        <li class="book_translator">
                            <p>옮긴이</p>
                            <span>{translator}</span>
                        </li>
                        <li class="book_publisher">
                            <p>출판사</p>
                            <span>{publisher}</span>
                        </li>
                        <li class="book_publishDate">
                            <p>출간일</p>
                            <span>{publishDate}</span>
                        </li>
                        <li class="book_btDate">
                            <p>북토크 진행일자</p>
                            <span>{btDate}</span>
                        </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="btn_update_info">
                <button class="button btn_updateBook">정보 수정</button>
            </div>
        </div>

        <!-- 한줄평 슬라이드-->
        <div class="wrapper sr_wrapper">
            <h4>회원들의 한줄평</h4>
            <div id="sr_template" style="display:none;">
                <li>
                    <strong>{content}</strong>
                    <em>{name}</em>
                    <span class="sr_idx" style="display:none;">{sr_idx}</span>
                </li>
            </div>
            <div class="sr_container">
                <div class="sr_box">
                    <!-- <button class="btn btn_left"><</button> -->
                    <div class="btn btn_left"></div>
                    <ul class="slider">
                    </ul>
                    <!-- <button class="btn btn_right">></button> -->
                    <div class="btn btn_right"></div>
                </div>

                <button class="button btn_write">글쓰기</button>
                <button class="button btn_update">내 한줄평 수정</button>
            </div>
            
            <div class="sr_container2">
                <div class="sr_box2">
                    <input type="text" class="ipt sr_ipt" placeholder="한줄평을 입력하세요. 하나의 한줄평만 작성할 수 있습니다.">
                </div>
                <button class="button btn_cancel">취소</button>
                <button class="button btn_regist">등록</button>
            </div>

            <div class="sr_container3">
                <div class="sr_box3">
                    <input type="text" class="ipt sr_ipt2">
                </div>
                <button class="button btn_cancel">취소</button>
                <button class="button btn_regist4">등록</button>
                <button class="button btn_delete5">한줄평 삭제</button>
            </div>
        </div>

        <!-- 서평 보드 -->
        <div class="wrapper mr_wrapper">
            <h4>회원들의 서평</h4>
            <div class="mr_container">
                <div class="mr_board">
                    <!-- 테이블 -->
                    <template id="tbody_template" style="display:none";>
                        <tr>
                            <td style="display:none;">
                                <span class="td_span_no">{no}</span>
                            </td>
                            <td>
                                {name}
                            </td>
                            <td class="td_title">
                                <span class="title_span" data-attr="{data-attr}" >{title}</span>
                            </td>
                            <td>
                                {date}
                            </td>
                        </tr>
                    </template>

                    <table>
                        <thead>
                            <tr>
                                <th class="th th_no" style="display:none;">no.</th>
                                <th class="th th_name">작성자</th>
                                <th class="th th_title">제목</th>
                                <th class="th th_date">작성일자</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <!-- 페이징 -->
                    <div class="pagination pagination_mr">
                    </div>
                </div>
                <div class="mr_btn">
                    <button class="button btn_write2">글쓰기</button>
                    <!-- <button class="button btn_update2">내 서평 수정</button> -->
                </div>
            </div>

            <div class="mr_container2">
                <div class="mr_board">
                    <h5>나의 서평</h5>
                    <input type="text" placeholder="작성자" class="ipt ipt_mr_writer" readonly>
                    <input type="text" placeholder="제목 (글자 수 제한 30자)" class="ipt ipt_mr_title">
                    <textarea name="maintext" class="ipt_mr_content" placeholder="* 서평을 입력해주세요(400~500자).&#13;&#10;* 책 한 권 당 서평은 한 번만 작성할 수 있습니다." rows="10"></textarea>
                </div>
                <div class="mr_btn">
                    <button class="button btn_cancel2">취소</button>
                    <button class="button btn_regist2">등록</button>
                </div>
            </div>

            <div class="mr_container3">
                <div class="mr_board">
                    <div class="detail detail_mr_idx" style="display:none;">{mr_idx}</div>
                    <div class="detail detail_mr_writer">
                        <div class="cn12">
                            <span class="cn cn_w">작성자</span>
                            <span class="cn_user">{mr_writer}</span>
                        </div>
                        <div class="cn3">
                            <span class="cn cn_d">작성일자</span>
                            <span class="cn_dt">{mr_writeDatetime}</span>
                        </div>
                    </div>
                    <!-- <div class="detail detail_mr_writeDatetime"></div> -->
                    <div class="detail detail_mrtitle">
                        <span class="cn cn_t">제목</span>
                        <span class="cn_ttl">{mr_title}</span>
                    </div>
                    <div class="detail detail_mr_content">
                        <div class="cn_ct">{mr_content}</div>
                    </div>
                </div>
                <div class="mr_btn">
                    <button class="button btn_cancel3">목록</button>
                    <button class="button btn_update2">수정</button>
                    <button class="button btn_delete6">삭제</button>
                </div>
            </div>
            <div class="mr_container4">
                <div class="mr_board">
                    <h4>나의 서평</h4>
                    <div class="detail detail_mr_idx" style="display:none;"></div>
                    <input type="text" placeholder="작성자" class="ipt ipt_mr_writer" readonly>
                    <input type="text" placeholder="제목" class="ipt ipt_mr_title">
                    <textarea name="maintext" class="ipt_mr_content" placeholder="* 서평을 입력해주세요(400~500자).&#13;&#10;* 책 한 권 당 서평은 한 번만 작성할 수 있습니다." rows="10"></textarea>
                </div>
                <div class="mr_btn">
                    <button class="button btn_cancel2">취소</button>
                    <button class="button btn_update5">수정</button>
                </div>
            </div>

        </div>

        <!-- 북토크 대화록 -->
        <div class="wrapper bt_wrapper">
            <h4>북토크 대화록</h4>
            <div class="bt_container">
                <span class="bt_writer"></span>
                <span class="bt_desc">.</span>
                <div class="bt_btn">
                    <button class="button btn_write3">글쓰기</button>
                    <button class="button btn_update3">수정하기</button>
                </div>
            </div>
            <div class="bt_container2">
                <div>
                    <input type="text" placeholder="작성자" class="ipt ipt_bt_writer" readonly>
                    <textarea name="maintext" class="ipt_bt_content" placeholder="* 북토크 대화록을 붙여 넣어주세요." rows="10"></textarea>
                </div>
                <div class="bt_btn">
                    <button class="button btn_cancel4">취소</button>
                    <button class="button btn_regist3">등록</button>
                </div>
            </div>
            <div class="bt_container3">
                <div>
                    <input type="text" placeholder="작성자" class="ipt ipt_bt_writer2" readonly>
                    <textarea name="maintext" class="ipt_bt_content2"  rows="10"></textarea>
                </div>
                <div class="bt_btn">
                    <button class="button btn_cancel6">취소</button>
                    <button class="button btn_delete4">대화록 삭제</button>
                    <button class="button btn_update4">대화록 수정</button>
                </div>
            </div>
        </div>

        <!-- 댓글 -->
        <div class="wrapper reply_wrapper">
            <h4>댓글</h4>
            <div id="reply_template" style="display:none;">
                <div class="reply_list">
                    <div class="reply reply_writer">
                        <span>{ReplyWriter}</span>
                    </div>
                    <div class="reply reply_content">
                        <span>{ReplyContent}</span>
                    </div>
                    <div class="reply_datetime_container">
                        <div class="reply_datetime">
                            <span>{Writedatetime}</span>
                            <button class="btn_x">X</button>
                        </div>
                        <div class="reply_datetime2">
                            <input type="password" name="reply_pw" placeholder="비밀번호 입력">
                            <button data-attr="{data-attr}" class="btn_delete3">삭제</button>
                            <button class="btn_cancel5">취소</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box reply_list_box">     
                <!-- <span>아직 작성된 댓글이 없습니다.</span> -->
            </div>

            <!-- 페이징 -->
            <div class="pagination pagination_reply">
            </div>

            <!-- 댓글 작성창 -->
            <div class="box reply_box">
                <div class="box reply_write_box">    
                    <div class="box reply_input_box">
                        <div class="ipt ipt_reply_name">
                            <input type="text" name="re_name" placeholder="작성자 명(20자 제한)" readonly>
                        </div>
                        <div class="ipt ipt_reply_pw">
                            <input type="password" name="re_password" placeholder="비밀번호" readonly>
                        </div>
                    </div>
                    <div class="box reply_textarea_box">
                        <textarea name="textarea" class="ipt_reply_content" rows="3" placeholder="내용을 입력하세요."></textarea>
                    </div>
                </div>
                <button class="button btn_reg">등록</button>
            </div>
        </div>
    </div>
</body>
</html>


