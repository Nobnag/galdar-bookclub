<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <title>도서 상세 페이지</title>
    <link rel="stylesheet" type="text/css" href="css/gnb.css" />
    <link rel="stylesheet" href="css/book_detail.css">
    <link rel="stylesheet" type="text/css" href="css/footer.css" />
    <script src="js/gnb.js"></script>
    <script src="js/footer.js"></script>
    <script>
        // url 에서 parameter 추출
        var getParam = function(sname) {
            var params = location.search.substr(location.search.indexOf("?") + 1);
            var sval = "";
            params = params.split("&");

            for (var i = 0; i < params.length; i++) {
                temp = params[i].split("=");
                if ([temp[0]] == sname) { sval = temp[1]; }
            }

            return sval;
        }

        // 줄글 서평 ID생성
        function getID(){
                var mr_id = $('.td_no').val();
                return mr_id;
            }

        // 0. 메인 화면
        $(document).ready(function(){
        // 0-1. 도서 상세 정보 조회
        // 0-1-1. 변수 저장
            var params = {
                book_idx: getParam('book_idx')
            };
        // 0-1-2. ajax 호출
            $.ajax({
                // url: 'http://localhost:3000/api/getBookDetail',
                url: '/api/getBookDetail',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    if(result.recordset.length == 0){
                        alert("유효한 페이지가 아닙니다.");
                        return false;
                    }

                    var data = result.recordset[0];
                    /* 첫번째 방법 */
                    var html = $(".container_book_contents").html();
                    html = html.replace(/{img}/gi, data.BookImg)
                                .replace(/{idx}/gi,data.BookIdx)
                                .replace(/{category}/gi,data.BookCategory)
                                .replace(/{title}/gi,data.BookTitle)
                                .replace(/{desc}/gi,data.BookDesc)
                                .replace(/{author}/gi,data.BookAuthor)
                                .replace(/{translator}/gi,data.BookTranslator)
                                .replace(/{publisher}/gi,data.BookPublisher)
                                .replace(/{publishDate}/gi,data.BookPubDate)
                                .replace(/{btDate}/gi,data.BookBtDate);
                    $(".container_book_contents").html(html);
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    alert("an error occured");
                }
            });
            
        // 0-2. 한줄평 조회
            $.ajax({
                url: '/api/getSR',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    // var data = result.recordset[0];
                    for(var i = 0; i < result.recordset.length; i ++){
                        var row = result.recordset[i];
                        var html = $('#sr_template').html().replace("{content}",row.SRContent).replace("{name}",row.SRWriter);
                        $('.sr_box .slider').append(html)
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });
            
        // 0-3. 줄글 서평 조회

            $.ajax({
                url: '/api/getMR',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    // var data = result.recordset[0];
                    for(var i = 0; i < result.recordset.length; i ++){
                        var row = result.recordset[i];
                        var html = $('#tbody_template').html().replace("{no}",row.MRIdx).replace("{name}",row.MRWriter).replace("{mr_id}",getID()).replace("{title}",row.MRTitle).replace("{date}",row.MRWriteDatetime);
                        $('.mr_board table').append(html);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });
        // 0-4. 북토크 대화록 조회
        // 0-5. 댓글 조회
            $.ajax({
                url: '/api/getReply',
                data: params,
                type: 'get',
                datatype: 'json',
                // async: false,
                success: function(result){
                    for(var i = 0; i < result.recordset.length; i ++){
                        var row = result.recordset[i];
                        var html = $('#reply_template').html().replace("{ReplyWriter}",row.ReplyWriter).replace("{ReplyContent}",row.ReplyContent).replace("{Writedatetime}",row.ReplyWriteDatetime);
                        $('.reply_list_box').append(html)
                    }
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log(errorThrown);
                    // alert("an error occured");
                }
            });
            
            // 1. 도서 정보 수정
            // 1-1.
            var book_idx = getParam('book_idx')
            $('.btn_update_info').click(function(){
                location.href=('./galdar_reg?book_idx='+book_idx)
            });

            // 2. 한줄평
            // 2-1. 글쓰기 버튼 클릭
            $('.btn_write').click(function(){
            // 2-2. 창 전환
                $('.sr_container').css('display','none');
                $('.sr_container2').css('display','block');
            });
            // 2-3. 등록버튼 클릭
            $('.btn_regist').click(function(){
            // 2-4. 이전에 작성한 적 있으면 불가입니다.
                // if()
            // 2-5. 값 가져오기
                var book_idx = $('.book_info ul .book_idx span').html();
                var sr_writer = '랜덤닉네임'
                var sr_content = $('.sr_ipt').val();
            // 2-6. 미입력시 안내
                if(sr_content == ""){
                    alert('한줄평을 입력하세요.');
                    return false;
                } 
                
            // 2-7. API 전송
            if(sr_content !== ""){
                    var params = {
                        book_idx: book_idx
                        ,sr_writer: '랜덤 닉네임'
                        ,sr_content: sr_content
                    };
                    $.ajax({
                        url: '/api/submitSR'
                        ,data: params
                        ,type: 'post' 
                        ,datatype: 'json'
                        ,success: function(result){
                            if(result.recordset.length > 0){
                            alert('한줄평이 등록되었습니다.');
                            location.href=('/book_detail?book_idx='+book_idx)
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                        }
                    });
                }

            // 2-7. append
                $('.slider').append("<li><strong>"+sr_content+"</strong><p><em>"+sr_writer+"</em></p></li>");

            // 2-8. 메세지
                // 2-8. 다시 창 전환
                $('.sr_container2').css('display','none');
                $('.sr_container').css('display','block');
                return true;
            });
            // });

            // 수정버튼 클릭
            $('.btn_update').click(function(){
                // 이전에 작성한 글이 있다면, 
                // if()
                // alert("이미 한줄평을 작성하였습니다.");
            });

            // 취소버튼 클릭
            $('.btn_cancel').click(function(){
            // 2-2. 창 전환
                if(confirm("작성된 글은 보관되지 않습니다. 취소하시겠습니까?")){
                    $('.sr_ipt').val('');
                    $('.sr_container2').css('display','none');
                    $('.sr_container').css('display','block');
                }
                else {
                    return false;
                }
            });


            // 3. 줄글 서평            
            // 3-1. 글쓰기 버튼 클릭
            $('.btn_write2').click(function(){
            // 3-2. 창 전환
                $('.mr_container').css('display','none');
                $('.mr_container2').css('display','block');
            });
            // 3-3. 등록버튼 클릭
            $('.btn_regist2').click(function(){
            // 3-4. 이전에 작성한 적 있으면 추가 작성 불가.
            // if()
            // 3-5. 값 가져오기
                var book_idx = $('.book_info ul .book_idx span').html();
                var mr_writer = $('.ipt_mr_writer').val();
                var mr_title = $('.ipt_mr_title').val();
                var mr_content = $('.ipt_mr_content').val();
            // 3-6. 미입력시 안내
                if(mr_title == '' || mr_content == ''){
                    alert("제목과 서평을 모두 입력해주세요.")
                    return false;
                } 
            // 3-7. API 전송
                if(mr_title !== "" && mr_writer !== "" && mr_content !== ""){
                    var data = {
                        book_idx: book_idx
                        ,mr_writer: mr_writer
                        ,mr_title: mr_title
                        ,mr_content: mr_content
                    };
                    $.ajax({
                        url: '/api/submitMR',
                        data: data,
                        type: 'post',
                        datatype: 'json',
                        // async: false,
                        success: function(result){
                            console.log(result);
                            alert("작성이 완료되었습니다.");
                            location.href=('/book_detail?book_idx='+book_idx)
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            // alert("an error occured");
                        }
                    });
                }
            });

            // 취소버튼 클릭
            $('.btn_cancel2').click(function(){
            // 2-2. 창 전환
                if(confirm("작성된 글은 보관되지 않습니다. 취소하시겠습니까?")){
                    $('.mr_container2').css('display','none');
                    $('.mr_container').css('display','block');
                }
                else {
                    return false;
                }
            });
                       
            // 상세 조회
            $('.td_title span').click(function(){
                
                /* var selected_mr_id = $(this).attr("id");
                $('.mr_container').html().replace('.mr_container3')
                var params = {
                    mr_writer: mr_writer
                    ,mr_writeDatetime: mr_writeDatetime
                    ,mr_title: mr_title
                    ,mr_content: mr_content
                } */
                var mr_idx = $('.td_no').val();
                var params2= {
                    mr_idx: mr_idx
                }

                $.ajax({
                    url: '/api/getMRdetail',
                    data: params2,
                    type: 'get',
                    datatype: 'json',
                    // async: false,
                    success: function(result){
                        // var data = result.recordset[0];
                        $('.mr_container').css('display','none');
                        $('.mr_container3').css('display','block');
                        alert("상세보기");
                        for(var i = 0; i < result.recordset.length; i ++){
                            var row = result.recordset[i];
                            var html = $('.mr_container3').html().replace("{mr_writer}",row.MRWriter).replace("{mr_title}",row.MRTitle).replace("{mr_content}",row.MRContent).replace("{mr_writeDatetime}",row.MRWriteDatetime);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        console.log(errorThrown);
                        // alert("an error occured");
                    } 
                });

            });

            // 4. 댓글
            $('.btn_reg').click(function(){
                var book_idx = $('.book_info ul .book_idx span').html();
                var reply_name = $('input[name="name"]').val().trim();
                var reply_pw = $('input[name="pw"]').val().trim();
                var reply_content = $('.ipt_reply_content').val().trim();

                if(reply_name == "" || reply_pw == "" || reply_content == ""){
                    alert('이름과 비밀번호, 내용을 모두 입력하세요.');
                    return false;
                } 
                
                if(reply_name !== "" && reply_pw !== "" && reply_content !== ""){
                    var params = {
                        book_idx: book_idx
                        ,reply_name: reply_name
                        ,reply_pw: reply_pw
                        ,reply_content: reply_content
                    };

                    $.ajax({
                        url: '/api/submitReply',
                        data: params,
                        type: 'post',
                        datatype: 'json',
                        // async: false,
                        success: function(result){
                            if(result.recordset[0].Result == 'Success'){
                                alert("작성이 완료되었습니다.");
                                location.href=('/book_detail?book_idx='+book_idx)
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown){
                            console.log(errorThrown);
                            // alert("an error occured");
                        }
                    });

                }
                
            });

            // 4-1. 삭제버튼
            $('.btn_x').click(function(){
                $(this).parent().css('display','none');
                $(this).parent().next().css('display','block');
            });



            // 한줄평 슬라이드 구현하기.
            // 변수 정의.
            var $slider = $('.slider');
            var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);
            
            startSlide();
            
            var theInterval;
            
            function startSlide(){
                theInterval = setInterval(NextSlide, 3000);
                var $firstSlide = $slider.find('li').first().stop(true).animate ({'opacity':1},100);
            };
            
            function stopSlide(){
                clearInterval(theInterval);
            }

            
            // '<' 버튼 누를 때 실행할 함수.
            function PrevSlide(){
                // 타이머 초기화
                stopSlide();
                startSlide();

                var $lastSlide = $slider.find('li').last().prependTo($slider);
                var $secondSlide = $slider.find('li').eq(1).stop(true).animate({'opacity':0},100);
                var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);
            }

            // '>' 버튼 누를 때 실행할 함수.
            function NextSlide(){
                // 타이머 초기화
                stopSlide();
                startSlide();

                $firstSlide = $slider.find('li').first().appendTo($slider);
                var $lastSlide = $slider.find('li').last().stop(true).animate({'opacity':0},100);
                var $firstSlide = $slider.find('li').first().stop(true).animate({'opacity':1},100);
            }
            
            // '<' 버튼 누를 때.
            $('.btn_left').on('click',function(){
                PrevSlide();
            });

            // '>' 버튼 누를 때.
            $('.btn_right').on('click',function(){
                NextSlide();
            });

            $('.slider').hover(function(){
                stopSlide();
            }, function(){
                startSlide();
            });
        });

    </script>
</head>
<body>
    <div class="container">
        <!-- 도서 정보 -->
        <div class="wrapper info_wrapper">
            <h4>도서 정보</h4>
            <div class="container_book_contents">
                <div class="book_img">
                    <img src="{img}">
                </div>
                <div class="book_info">
                    <ul>
                        <li class="book_category">{category}</li>
                        <h2 class="book_title">{title}</h2>
                        <li class="book_desc">{desc}</li>
                        <li class="book_idx">
                            <p>도서번호</p>
                            <span>{idx}</span>
                        </li>
                        <li class="book_author">
                            <p>저자</p>
                            <span>{author}</span>
                        </li>
                        <li class="book_translator">
                            <p>옮긴이</p>
                            <span>{translator}</span>
                        </li>
                        <li class="book_publisher">
                            <p>출판사</p>
                            <span>{publisher}</span>
                        </li>
                        <li class="book_publishDate">
                            <p>출간일</p>
                            <span>{publishDate}</span>
                        </li>
                        <li class="book_btDate">
                            <p>북토크 진행일자</p>
                            <span>{btDate}</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="btn_update_info">
                <button class="button">정보 수정</button>
            </div>
        </div>

        <!-- 한줄평 슬라이드-->
        <div class="wrapper sr_wrapper">
            <h4>회원들의 한줄평</h4>
            <div id="sr_template" style="display:none;">
                <li>
                    <strong>{content}</strong>
                    <em>{name}</em>
                </li>
            </div>
            <div class="sr_container">
                <div class="sr_box">
                    <button class="btn btn_left"><</button>
                    <ul class="slider">
                        
                    </ul>
                    <button class="btn btn_right">></button>
                </div>

                <button class="button btn_write">글쓰기</button>
                <button class="button btn_update">내 한줄평 수정</button>
            </div>
            
            <div class="sr_container2">
                <div class="sr_box2">
                    <input type="text" class="ipt sr_ipt" placeholder="한줄평을 입력하세요. 하나의 한줄평만 작성할 수 있습니다.">
                </div>
                <button class="button btn_cancel">취소</button>
                <button class="button btn_regist">등록</button>
            </div>
        </div>

        <!-- 서평 보드 -->
        <div class="wrapper mr_wrapper">
            <h4>회원들의 서평</h4>
            
            <div class="mr_container">
                <div class="mr_board">
                    <!-- 테이블 -->
                    <table>
                        <thead>
                            <tr>
                                <th class="th th_no">no.</th>
                                <th class="th th_name">작성자</th>
                                <th class="th th_title">제목</th>
                                <th class="th th_date">작성일자</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_template" style="display:none";>
                            <tr>
                                <td class="td_no">{no}</td>
                                <td>{name}</td>
                                <td class="td_title">
                                    <span id="{id}">{title}</span>
                                </td>
                                <td>{date}</td>
                            </tr>
                        </tbody>
    
                    </table>
                    <!-- 페이징 -->
                    <div class="paging">
                        <a href="#" class="btn_left"><</a>
                        <ol>
                            <a href="#"><li>{page_no}</li></a>
                        </ol>
                        <a href="" class="btn_right">></a>
                    </div>
                </div>
                <div class="mr_btn">
                    <button class="button btn_write2">글쓰기</button>
                    <button class="button btn_update2">내 서평 수정</button>
                </div>
            </div>

            <div class="mr_container2">
                <div class="mr_board">
                    <h4>나의 서평</h4>
                    <input type="text" placeholder="작성자" class="ipt ipt_mr_writer">
                    <input type="text" placeholder="제목" class="ipt ipt_mr_title">
                    <textarea name="maintext" class="ipt_mr_content" placeholder="* 서평을 입력해주세요(400~500자).&#13;&#10;* 책 한 권 당 서평은 한 번만 작성할 수 있습니다." rows="10"></textarea>
                </div>
                <div class="mr_btn">
                    <button class="button btn_cancel2">취소</button>
                    <button class="button btn_regist2">등록</button>
                </div>
            </div>

            <div class="mr_container3">
                <div class="mr_board">
                    <div class="detail detail_mr_writer">{mr_writer}</div>
                    <div class="detail detail_mr_writeDatetime">{mr_writeDatetime}</div>
                    <div class="detail detail_mr_title">{mr_title}</div>
                    <div class="detail detail_mr_content">{mr_content}</div>
                </div>
                <div class="mr_btn">
                    <button class="button btn_cancel2">취소</button>
                    <button class="button btn_regist2">등록</button>
                </div>
            </div>

        </div>

        <!-- 북토크 대화록 -->
        <div class="wrapper bt_wrapper">
            <h4>북토크 대화록</h4>
            <div class="box bt_box">
                
            </div>
            <button class="button btn_regist3">등록</button>
        </div>

        <!-- 댓글 -->
        <div class="wrapper reply_wrapper">
            <h4>댓글</h4>
            <div id="reply_template" style="display:none;">
                <div class="reply_list">
                    <div class="reply reply_writer">
                        <span>{ReplyWriter}</span>
                    </div>
                    <div class="reply reply_content">
                        <span>{ReplyContent}</span>
                        <div class="reply_datetime">
                            <span>{Writedatetime}</span>
                            <button class="btn_x">X</button>
                        </div>
                        <div class="reply_datetime2">
                            <input type="password" name="pw" placeholder="비밀번호를 입력하세요.">
                            <button class="btn_delete3">삭제</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="box reply_list_box">
                <!-- 댓글 리스트 -->
                <!-- <div class="reply_list">
                    <div class="reply reply_writer">
                        <span>{ReplyWriter}</span>
                    </div>
                    <div class="reply reply_content">
                        <span>{ReplyContent}</span>
                        <div class="reply_datetime">
                            <span>{Writedatetime}</span>
                            <button>X</button>
                        </div>
                        <div class="reply_datetime2">
                            <input type="password" name="pw" placeholder="비밀번호를 입력하세요.">
                            <button class="btn_delete3">삭제</button>
                        </div>
                    </div>
                </div> -->
                
            </div>
            <!-- 페이징 -->
            <div class="paging">
                <a href="#" class="btn_left"><</a>
                <ol>
                    <a href="#"><li>{page_no}</li></a>
                </ol>
                <a href="" class="btn_right">></a>
            </div>
            <!-- 댓글 작성창 -->
            <div class="box reply_box">
                <div class="box reply_write_box">    
                    <div class="box reply_input_box">
                        <div class="ipt ipt_reply_name">
                            <input type="text" name="name" placeholder="작성자 명">
                        </div>
                        <div class="ipt ipt_reply_pw">
                            <input type="password" name="pw" placeholder="비밀번호">
                        </div>
                    </div>
                    <div class="box reply_textarea_box">
                        <textarea name="textarea" class="ipt_reply_content" rows="3" placeholder="내용을 입력하세요."></textarea>
                    </div>
                </div>
                <button class="button btn_reg">등록</button>
            </div>
        </div>
    </div>
</body>
</html>